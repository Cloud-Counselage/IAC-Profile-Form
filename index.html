<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAC Profile Form</title>
    <style>
      :root {
        --primary-gradient: linear-gradient(135deg, #ea7317 0%, #ff9f43 100%);
        --primary-color: #ea7317;
        --secondary-color: #3da5d9;
        --text-dark: #2d3436;
        --text-medium: #636e72;
        --bg-color: #f0f2f5;
        --white: #ffffff;
        --shadow-md: 0 10px 20px rgba(0,0,0,0.1);
        --transition: all 0.3s ease;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
      
      body { background: var(--primary-gradient); padding: 20px; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; }
      
      .container { width: 100%; max-width: 750px; background: var(--white); padding: 40px; border-radius: 16px; box-shadow: var(--shadow-md); margin-top: 20px; position: relative; }

      /* HEADER */
      .header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #f1f1f1; }
      .header-logo { width: 80px; height: 80px; object-fit: contain; border-radius: 8px; }
      h2 { color: var(--text-dark); font-size: 26px; font-weight: 700; }
      .global-desc { font-size: 14px; color: var(--text-medium); line-height: 1.6; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #f1f1f1; }

      /* INPUTS & FIELDS */
      .control-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
      label { font-weight: 600; color: var(--text-dark); font-size: 14px; margin-bottom: 6px; display: block; }
      
      input, select, textarea { 
        width: 100%; padding: 12px 16px; border-radius: 8px; border: 2px solid #e0e0e0; 
        background: #fafafa; font-size: 15px; transition: var(--transition); 
      }
      input:focus, select:focus { border-color: var(--secondary-color); outline: none; background: #fff; box-shadow: 0 0 0 4px rgba(61, 165, 217, 0.1); }

      /* BUTTONS */
      .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 15px; transition: var(--transition); }
      .btn.primary { background: var(--primary-gradient); color: var(--white); box-shadow: 0 4px 10px rgba(234, 115, 23, 0.3); }
      .btn.primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(234, 115, 23, 0.4); }
      .btn.primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
      .btn.ghost { background: transparent; border: 2px solid var(--secondary-color); color: var(--secondary-color); }
      .btn.ghost:hover { background: #eaf6fc; }

      .action-buttons { display: flex; gap: 12px; margin-top: 10px; }

      /* ANIMATIONS */
      @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .field { margin-bottom: 20px; animation: fadeInUp 0.4s ease-out forwards; opacity: 0; }
      .field:nth-child(n+1) { animation-delay: 0.1s; }

      /* RADIO & CHECKBOX */
      .radio-group { display: flex; gap: 20px; align-items: center; }
      .radio-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 500; }
      .radio-label input { width: 18px; height: 18px; margin: 0; cursor: pointer; }

      /* MULTI-SELECT */
      .multi-checkbox-wrap { border: 1px solid #e0e0e0; padding: 10px; border-radius: 8px; max-height: 200px; overflow-y: auto; background: #fff; }
      .multi-checkbox-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: background 0.2s; border-radius: 6px; }
      .multi-checkbox-item:hover { background: #f9f9f9; }
      .multi-checkbox-item.selected { background: #e6f4fa; border-left: 4px solid var(--secondary-color); }
      .multi-checkbox-item input { width: 16px; height: 16px; }
      .multi-search { margin-bottom: 8px; font-size: 13px; padding: 8px; }

      /* PHONE ROW */
      .phone-row { display: flex; gap: 10px; }
      .phone-row select { width: 35%; max-width: 110px; }
      .phone-row input { flex: 1; }

      /* UTILS */
      .hidden { display: none !important; }
      .hint { font-size: 12px; color: var(--text-medium); margin-top: 4px; }
      .file-existing-note { font-size: 13px; color: #2e7d32; margin-top: 6px; font-weight: 500; }
      .file-existing-note a { color: #2e7d32; text-decoration: underline; }
      .other-hint { font-size: 12px; color: #e65100; margin-top: 4px; font-style: italic; }

      /* VALIDATION MESSAGES */
      .validation-msg { font-size: 13px; margin-top: 6px; font-weight: 600; min-height: 20px; display: flex; align-items: center; gap: 6px; }
      .validation-msg.error { color: #d32f2f; }
      .validation-msg.success { color: #2e7d32; }
      .validation-msg.checking { color: var(--primary-color); }

      /* FULL SCREEN LOADING OVERLAY */
      .loading-overlay { 
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
        background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); 
        z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
      }
      .loading-overlay.active { opacity: 1; pointer-events: all; }
      .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
      .loading-text { margin-top: 20px; font-weight: 700; font-size: 18px; color: var(--text-dark); }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* SUCCESS SCREEN (CARDS) */
      .success-box { text-align: center; animation: fadeInUp 0.5s ease-out; }
      .success-icon { font-size: 48px; margin-bottom: 16px; display: block; }
      .success-title { font-size: 24px; color: var(--text-dark); margin-bottom: 12px; }
      .success-desc { color: var(--text-medium); margin-bottom: 30px; }
      
      .cards-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 20px; }
      .card-link { 
        text-decoration: none; background: #fff; border: 1px solid #eee; border-radius: 12px; 
        padding: 20px; text-align: center; transition: var(--transition); display: flex; flex-direction: column; align-items: center; gap: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      }
      .card-link:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: var(--primary-color); }
      .card-icon { font-size: 28px; }
      .card-title { font-weight: 700; color: var(--text-dark); font-size: 16px; }
      .card-sub { font-size: 12px; color: var(--text-medium); }

      /* FACULTY BOX */
      .faculty-box { text-align: center; padding: 40px 20px; background: #f8f9fa; border-radius: 12px; border: 1px dashed #ccc; }
      .faculty-box h3 { margin-bottom: 10px; color: var(--text-dark); }

      /* MOBILE */
      @media (max-width: 600px) {
        .container { padding: 24px; }
        .cards-grid { grid-template-columns: 1fr; }
        .action-buttons { flex-direction: column; }
        .btn { width: 100%; }
      }
    </style>
  </head>
  <body>
    <div id="loader" class="loading-overlay">
      <div class="spinner"></div>
      <div id="loaderText" class="loading-text">Loading Application...</div>
    </div>

    <div class="container">
      <header class="header">
        <img id="companyLogo" class="header-logo" src="" alt="Company logo" style="display:none" />
        <div><h2>IAC Profile Form</h2></div>
      </header>

      <p id="globalDescription" class="global-desc">
        Filling this profile form helps us understand your skills, goals, and interests so we can connect you to the right industry training, mentorship, internships, jobs, and career-building opportunities. Your details enable Cloud Counselage and IAC to personalize your journey and match you with programs, guidance, and resources that support your professional growth and future success.
      </p>

      <div class="control-row">
        <label for="personaSelect">Which describes you the best?</label>
        <select id="personaSelect" required><option value="">Select Persona</option></select>
      </div>

      <div id="actionButtons" class="action-buttons hidden">
        <button id="btnNew" class="btn primary">Start New Application</button>
        <button id="btnEdit" class="btn ghost">Edit Existing Application</button>
      </div>

      <div id="facultyImmediateArea" class="hidden" style="margin-top:20px;">
         </div>

      <div id="workflowArea">
        <div id="facultyCtaArea" class="hidden" style="margin:12px 0;"></div>
        
        <div id="editEmailArea" class="hidden" style="margin-top:20px; padding:20px; background:#f9f9f9; border-radius:8px;">
          <label>Enter your registered Email ID to load data:</label>
          <div style="display:flex; gap:10px; margin-top:8px;">
            <input id="editEmailInput" type="email" placeholder="example@email.com" required />
            <button id="loadButton" class="btn primary">Load</button>
          </div>
        </div>

        <div id="formContainer" class="hidden" style="margin-top:24px;"></div>
        <div id="messageArea" style="margin-top:20px"></div>
      </div>
    </div>

    <script>
      // ==========================================
      // ‚ö†Ô∏è IMPORTANT: PASTE YOUR DEPLOYED WEB APP URL HERE
      // ==========================================
      const API_URL = "https://script.google.com/macros/s/AKfycbxR1GoCK-OILKKliRcnzqN8L5VQSeNnfIUrE1BiGWY11kkbng8gjKTDhWA55wgYAerglw/exec"; 

      let PERSONA_FIELDS = {};
      let APP_CONFIG = {};
      let currentPersona = '';
      let currentMode = ''; 

      // UI References
      const loader = document.getElementById('loader');
      const loaderText = document.getElementById('loaderText');
      const personaSelect = document.getElementById('personaSelect');
      const actionButtons = document.getElementById('actionButtons');
      const facultyImmediateArea = document.getElementById('facultyImmediateArea'); // NEW
      const btnNew = document.getElementById('btnNew');
      const btnEdit = document.getElementById('btnEdit');
      const editEmailArea = document.getElementById('editEmailArea');
      const editEmailInput = document.getElementById('editEmailInput');
      const loadButton = document.getElementById('loadButton');
      const formContainer = document.getElementById('formContainer');
      const messageArea = document.getElementById('messageArea');
      const companyLogoImg = document.getElementById('companyLogo');

      // Constants
      const YES_NO_FIELDS = [
        "Have you upskilled or taken courses during the break?", "Are You Interested in Internship / Job Opportunities?",
        "Are You Considering Transitioning to a Different Domain or Industry?", "Are You Open to Part-time, Freelance, or Remote Work Opportunities?",
        "Are You interested in Entrepreneurship as a career option?", "Willing to Work Without Stipend for First 3 Months (Full-time Internship)",
        "Would You Like to Connect with Mentors or Industry Professionals?", "Would You Like Guidance on Resume Building & Interview Preparation?",
        "Do You Agree to Terms of Engagement?", "Do You Agree to Receive Communications from Us?", "Do You Want to Become a Community Ambassador?", "Internships Completed",
        "Will You Need Corporate Feedback Report to Submit in Your College?"
      ];

      const MULTI_SELECT_MAP = {
        'Student': [ "Preferred Industry / Career Path / Field of Interest", "Academic Work & Hands-On Experience", "Current Skills (Technical & Soft)", "Skills You Want to Develop (Next 6‚Äì12 Months)" ],
        'Working Professional': [ "Preferred Industry / Career Path / Field of Interest", "Current Skills (Technical & Soft)", "Skills You Want to Develop (Next 6‚Äì12 Months)" ],
        'Professional on a Career Break': [ "Preferred Industry / Career Path / Field of Interest", "Current Skills (Technical & Soft)", "Skills You Want to Develop (Next 6‚Äì12 Months)" ]
      };

      const INTERNSHIP_DURATION_OPTIONS = ['3 months', '6 months', '6 months+'];

      // --- UTILS ---
      function showLoading(msg = "Loading...") { loaderText.textContent = msg; loader.classList.add('active'); }
      function hideLoading() { loader.classList.remove('active'); }
      function showMessage(text, type='success') {
        messageArea.innerHTML = `<div class="message" style="background:${type==='error'?'#ffebee':'#e8f5e9'}; color:${type==='error'?'#c62828':'#2e7d32'}; border:1px solid ${type==='error'?'#ef9a9a':'#a5d6a7'};">${text}</div>`;
        messageArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
      function sanitizeId(s) { return String(s).replace(/[^a-z0-9\-_]/ig,'_'); }

      function createDatalist(id, items) {
        let d = document.getElementById(id);
        if (!d) { d = document.createElement('datalist'); d.id = id; document.body.appendChild(d); }
        else { d.innerHTML = ''; }
        
        let finalList = items || [];
        const listsWithOther = ['universities_list', 'cities_list', 'countries_list', 'industries_list'];
        if (listsWithOther.includes(id) && !finalList.includes('Other')) {
            finalList = [...finalList, 'Other'];
        }
        
        finalList.forEach(it => { const o=document.createElement('option'); o.value=it; d.appendChild(o); });
      }

      function createCheckboxList(fieldName, options) {
        const wrap = document.createElement('div'); wrap.className = 'field';
        wrap.innerHTML = `<label>${fieldName}</label><input type="text" class="multi-search" placeholder="Search options...">`;
        const listWrap = document.createElement('div'); listWrap.className = 'multi-checkbox-wrap'; listWrap.id = 'wrap_' + sanitizeId(fieldName);
        
        options.forEach((opt) => {
          const row = document.createElement('div'); row.className = 'multi-checkbox-item'; row.tabIndex = 0;
          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = opt; cb.name = fieldName; cb.dataset.group = 'multi';
          const txt = document.createElement('div'); txt.className = 'mk-label'; txt.textContent = opt;
          row.onclick = function() { cb.checked = !cb.checked; row.classList.toggle('selected', cb.checked); };
          row.appendChild(cb); row.appendChild(txt); listWrap.appendChild(row);
        });
        wrap.appendChild(listWrap);
        
        wrap.querySelector('.multi-search').addEventListener('input', function(){
          const q = this.value.toLowerCase();
          listWrap.querySelectorAll('.multi-checkbox-item').forEach(it => {
            it.style.display = (it.textContent.toLowerCase().indexOf(q) !== -1) ? '' : 'none';
          });
        });
        return wrap;
      }

      // --- LOGIC ---
      function toggleFormFields(form, disabled) {
         const elements = Array.from(form.elements);
         const emailIdx = elements.findIndex(el => el.name === "Personal Email ID");
         if(emailIdx === -1) return;
         for (let i = emailIdx + 1; i < elements.length; i++) {
             if (elements[i].type !== 'submit') {
                 elements[i].disabled = disabled;
                 const wrapper = elements[i].closest('.field');
                 if(wrapper) wrapper.style.opacity = disabled ? '0.5' : '1';
             }
         }
      }

      function populateControlsFromPrefill(formEl, prefillValues) {
        if (!prefillValues) return;
        
        Array.from(formEl.elements).forEach(i => {
          let val = prefillValues[i.name];
          if (val === undefined || val === null) return;
          
          if (i.type === 'checkbox') {
             if (i.dataset.group !== 'multi') { 
                i.checked = (String(val).toLowerCase() === 'yes'); 
             }
             return; 
          }
          else if (i.type === 'radio') { 
             if (String(i.value).toLowerCase() === String(val).toLowerCase()) {
                 i.checked = true;
                 if (i.name.toLowerCase().indexOf("interested in internship") !== -1 && i.value === "Yes") {
                    const target = document.getElementById('div_internship_duration');
                    const sel = target ? target.querySelector('select') : null;
                    if(target) target.style.display = 'block';
                    if(sel) sel.required = true;
                 }
             } 
          }
          else if (i.type === 'date') {
             // Backend sends YYYY-MM-DD. Input expects YYYY-MM-DD. 
             // We trim just in case, but no re-formatting needed if format is correct.
             if (val && val.length >= 10) { i.value = val.substring(0, 10); }
          }
          else if (i.type !== 'file') {
            if (/mobile/i.test(i.name)) {
                const fullPhone = String(val).trim();
                const countryCodes = APP_CONFIG.countryCodes || [];
                if (i.tagName === 'SELECT') {
                    i.value = "";
                    for (let c of countryCodes) {
                        if (fullPhone.startsWith(c.code)) { i.value = c.code; break; }
                    }
                } else if (i.tagName === 'INPUT') {
                    let cleanPhone = fullPhone;
                    for (let c of countryCodes) {
                        if (cleanPhone.startsWith(c.code)) { cleanPhone = cleanPhone.substring(c.code.length).trim(); break; }
                    }
                    i.value = cleanPhone;
                }
            } 
            else if ((/University|College|City|Country|Industry/i.test(i.name)) && i.tagName === 'INPUT' && i.type === 'text') {
                let list = [];
                if(/University|College/i.test(i.name)) list = APP_CONFIG.selectOptions.universities;
                else if(/City/i.test(i.name)) list = APP_CONFIG.selectOptions.cities;
                else if(/Country/i.test(i.name)) list = APP_CONFIG.selectOptions.countries;
                else if(/Industry/i.test(i.name) && !/Preferred/i.test(i.name)) list = APP_CONFIG.selectOptions.industries; 

                const inList = list && list.some(item => String(item).toLowerCase() === String(val).toLowerCase());

                if (list && list.length > 0 && !inList && val !== 'Other' && val.trim() !== '') {
                    i.value = 'Other';
                    const customInput = formEl.querySelector(`input[name="${i.name}_custom"]`);
                    if(customInput) { customInput.value = val; customInput.classList.remove('hidden'); customInput.required = true; }
                } else {
                    i.value = val;
                }
            }
            else { i.value = val; }
          }
        });
        
        Object.keys(prefillValues).forEach(k => {
           let val = prefillValues[k];
           if (!val || String(val).trim() === "") return;
           const checkboxes = formEl.querySelectorAll(`input[type="checkbox"][name="${k}"][data-group="multi"]`);
           if(checkboxes.length > 0) {
             const parts = String(val).split(',').map(s=>s.trim()).filter(s => s !== "");
             if (parts.length > 0) {
                 checkboxes.forEach(cb => { 
                     if(parts.includes(cb.value.trim())) { cb.checked = true; cb.parentElement.classList.add('selected'); } 
                 });
             }
           }
        });
      }

      function buildFormForPersona(persona, prefillValues) {
        formContainer.innerHTML = ''; 
        formContainer.classList.remove('hidden');
        messageArea.innerHTML = ''; 

        // Note: Faculty check moved to Listener, but kept here for fallback
        if (persona === "College Faculty") { return; }

        const fields = PERSONA_FIELDS[persona] || [];
        const formEl = document.createElement('form'); formEl.id='personaForm';
        formEl.onsubmit = function(e){ e.preventDefault(); handleSubmit(persona); };

        const btn = document.createElement('button'); 
        btn.className='btn primary'; btn.textContent='Submit Application'; btn.style.marginTop = '20px';
        btn.id = 'btnSubmitForm';

        fields.forEach(name => {
          if(!name) return;
          if(name === "Mobile Country Code") return; // HIDE EXTRA FIELD

          if (name === "Personal Email ID") {
             const div = document.createElement('div'); div.className='field';
             div.innerHTML = `<label>${name} <span style="color:red">*</span></label>
                              <input type="email" name="${name}" required>
                              <div id="emailValidationMsg" class="validation-msg"></div>`;
             formEl.appendChild(div);

             if (currentMode === 'new') {
                 const emailInput = div.querySelector('input');
                 const msgDiv = div.querySelector('#emailValidationMsg');
                 emailInput.addEventListener('blur', function() {
                    const email = this.value.trim();
                    if (!email) { msgDiv.textContent = ''; return; }
                    msgDiv.textContent = "Checking availability..."; msgDiv.className = "validation-msg checking";
                    btn.disabled = true; 
                    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "emailExists", payload: { persona: currentPersona, email: email } }) })
                    .then(r => r.json()).then(exists => {
                        if (exists) {
                            msgDiv.innerHTML = "üö´ Application exists. Use <b>Edit</b> mode.";
                            msgDiv.className = "validation-msg error";
                            btn.disabled = true; toggleFormFields(formEl, true);
                        } else {
                            msgDiv.innerHTML = "‚úÖ Email available.";
                            msgDiv.className = "validation-msg success";
                            btn.disabled = false; toggleFormFields(formEl, false);
                        }
                    }).catch(() => { msgDiv.textContent = "Error verifying email."; });
                 });
             }
          }
          else if (/^\s*Terms\s*&\s*Conditions\s*$/i.test(name)) {
             const div = document.createElement('div'); div.className='field';
             div.innerHTML = `<label>Do you agree with our terms & conditions?</label>
               <div class="radio-group"><label class="radio-label"><input type="radio" name="${name}" value="Yes" required> Yes</label><label class="radio-label"><input type="radio" name="${name}" value="No"> No</label></div>
               <button type="button" class="btn ghost" style="margin-top:10px; font-size:13px; padding:8px 16px;" onclick="window.open('${APP_CONFIG.termsUrl || '#'}','_blank')">üìÑ View Terms & Conditions</button>`;
             formEl.appendChild(div);
          }
          else if(YES_NO_FIELDS.includes(name)) {
             const div = document.createElement('div'); div.className='field';
             div.innerHTML = `<label>${name}</label><div class="radio-group"><label class="radio-label"><input type="radio" name="${name}" value="Yes" required> Yes</label><label class="radio-label"><input type="radio" name="${name}" value="No"> No</label></div>`;
             formEl.appendChild(div);
             
             if (name.toLowerCase().indexOf("interested in internship") !== -1) {
                 div.querySelectorAll('input').forEach(r => {
                     r.addEventListener('change', () => {
                         const target = document.getElementById('div_internship_duration');
                         const sel = target ? target.querySelector('select') : null;
                         if (target && sel) {
                             if(r.value === 'Yes') {
                                 target.style.display = 'block';
                                 sel.required = true;
                             } else {
                                 target.style.display = 'none';
                                 sel.required = false;
                                 sel.value = "";
                             }
                         }
                     });
                 });
             }
          } 
          else if (/resume/i.test(name)) {
             const existingUrl = prefillValues ? prefillValues[name] : null;
             const isRequired = !existingUrl; 
             const div = document.createElement('div'); div.className='field';
             let html = `<label>${name} ${isRequired?'<span style="color:red">*</span>':''}</label>`;
             if (existingUrl) { html += `<div class="file-existing-note">‚úÖ <a href="${existingUrl}" target="_blank">View Current Resume</a></div><div class="hint">Upload new to replace.</div>`; }
             html += `<input type="file" name="${name}" accept="application/pdf" ${isRequired ? 'required' : ''}><div class="hint">PDF only, max 10MB</div>`;
             div.innerHTML = html; formEl.appendChild(div);
          } 
          else if (/Portfolio/i.test(name)) {
             const div = document.createElement('div'); div.className='field';
             div.innerHTML = `<label>${name} <span style="font-weight:normal; color:#666;">(Optional)</span></label><input type="text" name="${name}" placeholder="https://...">`;
             formEl.appendChild(div);
          }
          else if (/Preferred Industry|Skills/i.test(name) && MULTI_SELECT_MAP[persona]?.includes(name)) {
             let opts = /Industry/i.test(name) ? APP_CONFIG.selectOptions.industries : APP_CONFIG.selectOptions.skills;
             formEl.appendChild(createCheckboxList(name, opts || []));
          } 
          else if (/Preferred Internship Duration/i.test(name)) {
             const div = document.createElement('div'); 
             div.className='field'; 
             div.id = 'div_internship_duration';
             div.style.display = 'none';
             let html = `<label>${name}</label><select name="${name}"><option value="">-- Select Duration --</option>`;
             INTERNSHIP_DURATION_OPTIONS.forEach(opt => { html += `<option value="${opt}">${opt}</option>`; });
             html += `</select>`; div.innerHTML = html; formEl.appendChild(div);
          }
          else if (/Mobile/i.test(name)) {
             const div = document.createElement('div'); div.className='field';
             let codeOpts = `<option value="">Code</option>`;
             (APP_CONFIG.countryCodes || []).forEach(c => { codeOpts += `<option value="${c.code}">${c.code} (${c.country})</option>`; });
             div.innerHTML = `<label>${name}</label><div class="phone-row"><select name="Mobile Country Code" required>${codeOpts}</select><input type="tel" name="${name}" placeholder="Phone Number" required></div>`;
             formEl.appendChild(div);
          }
          else if (/Date of Birth/i.test(name)) {
             const div = document.createElement('div'); div.className='field';
             div.innerHTML = `<label>${name}</label><input type="date" name="${name}" required max="${new Date().toISOString().split('T')[0]}">`;
             formEl.appendChild(div);
          }
          else if (/Degree/i.test(name)) {
             const div = document.createElement('div'); div.className='field';
             let html = `<label>${name}</label><select name="${name}" required><option value="">-- Select Degree --</option>`;
             (APP_CONFIG.degrees || []).forEach(d => { html += `<option value="${d}">${d}</option>`; });
             html += `</select>`; div.innerHTML = html; formEl.appendChild(div);
          }
          else if ((/Year of Graduation|Year/i.test(name)) && (!/Study|Experience/i.test(name))) {
             const div = document.createElement('div'); div.className='field';
             let html = `<label>${name}</label><select name="${name}" required><option value="">-- Select Year --</option>`;
             (APP_CONFIG.years || []).forEach(y => { html += `<option value="${y}">${y}</option>`; });
             html += `</select>`; div.innerHTML = html; formEl.appendChild(div);
          }
          else if (/Year of Study/i.test(name)) {
             const div = document.createElement('div'); div.className='field';
             div.innerHTML = `<label>${name}</label><select name="${name}" required><option value="">-- Select Year --</option><option value="1st Year">1st Year</option><option value="2nd Year">2nd Year</option><option value="3rd Year">3rd Year</option><option value="Final Year">Final Year</option><option value="Postgraduate">Postgraduate</option></select>`;
             formEl.appendChild(div);
          }
          else if (/University|College|City|Country|How Did You Hear|Company|Industry/i.test(name)) {
             const div = document.createElement('div'); div.className='field';
             let listId = "";
             if(/University|College/i.test(name)) listId = "universities_list"; 
             else if(/City/i.test(name)) listId = "cities_list";
             else if(/Country/i.test(name)) listId = "countries_list";
             else if(/How/i.test(name)) listId = "sources_list";
             else if(/Company/i.test(name)) listId = "companies_list";
             else if(/Industry/i.test(name)) listId = "industries_list"; 
             
             let hintHTML = "";
             if (/University|College|City|Country|Industry/i.test(name)) {
                 hintHTML = `<div class="other-hint">Can't find your option? Select 'Other' from the list to enter it manually.</div>`;
             }

             div.innerHTML = `<label>${name}</label>
               <input type="text" name="${name}" list="${listId}" required placeholder="Type to search...">
               ${hintHTML}
               <input type="text" name="${name}_custom" class="hidden" placeholder="Please specify..." style="margin-top:8px; border-color:#3da5d9;">`;
             
             const mainInput = div.querySelector(`input[name="${name}"]`);
             const customInput = div.querySelector(`input[name="${name}_custom"]`);
             
             mainInput.addEventListener('input', function() {
                if (this.value === 'Other') {
                    customInput.classList.remove('hidden');
                    customInput.required = true;
                    customInput.focus();
                } else {
                    customInput.classList.add('hidden');
                    customInput.required = false;
                    customInput.value = '';
                }
             });

             formEl.appendChild(div);
          } 
          else {
             const div = document.createElement('div'); div.className='field';
             div.innerHTML = `<label>${name}</label><input type="text" name="${name}" required>`;
             formEl.appendChild(div);
          }
        });

        formEl.appendChild(btn);
        formContainer.appendChild(formEl);
        if(prefillValues) populateControlsFromPrefill(formEl, prefillValues);
      }

      function handleSubmit(persona) {
        const form = document.getElementById('personaForm');
        if(!form.checkValidity()) { form.reportValidity(); return; }

        const values = {}; const fileReads = [];
        let mobileCode = "";
        
        Array.from(form.elements).forEach(el => {
           if(el.name && el.type !== 'submit' && !el.disabled && !el.name.endsWith('_custom')) {
             
             if (el.name === "Mobile Country Code") { 
                 mobileCode = el.value; 
                 values[el.name] = el.value; 
             }
             
             else if (el.type === 'file') {
                 if (el.files.length > 0) {
                    const f = el.files[0];
                    const p = new Promise((resolve) => {
                       const reader = new FileReader();
                       reader.onload = e => resolve({ key: el.name, val: { filename: f.name, mimeType: f.type, base64: e.target.result.split(',')[1] } });
                       reader.readAsDataURL(f);
                    });
                    fileReads.push(p);
                 }
                 return; 
             }

             else if(el.type === 'checkbox' && el.dataset.group === 'multi') {
               if(!values[el.name]) values[el.name] = [];
               if(el.checked) values[el.name].push(el.value);
             } 
             else if (el.type === 'radio') {
                if(el.checked) values[el.name] = el.value;
             } 
             else if (el.type === 'date') {
                // ‚úÖ DATE FIX: Send raw ISO string (YYYY-MM-DD). Do not convert to DD/MM/YYYY.
                values[el.name] = el.value; 
             } 
             else {
                if (el.value === 'Other') {
                   const customEl = form.querySelector(`input[name="${el.name}_custom"]`);
                   if (customEl && customEl.value) {
                       values[el.name] = customEl.value;
                   } else {
                       values[el.name] = 'Other'; 
                   }
                } else {
                   values[el.name] = el.value;
                }
             }
           }
        });

        const mobileKey = Object.keys(values).find(k => /Mobile Number/i.test(k));
        if (mobileKey && mobileCode) { values[mobileKey] = mobileCode + " " + values[mobileKey]; }
        
        Object.keys(values).forEach(k => { 
            if(Array.isArray(values[k])) {
                values[k] = values[k].length > 0 ? values[k].join(', ') : "";
            }
        });

        showLoading('Submitting Application...');

        Promise.all(fileReads).then(files => {
           files.forEach(f => values[f.key] = f.val);
           const payload = { action: "upsertRecord", payload: { persona, values } };
           
           if(currentMode === 'new') {
             fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "emailExists", payload: { persona, email: values['Personal Email ID'] } }) })
             .then(r=>r.json()).then(exists => {
                if(exists) {
                   hideLoading();
                   showMessage('Email already exists. Please use Edit mode.', 'error');
                } else {
                   sendData(payload);
                }
             });
           } else {
             sendData(payload);
           }
        });
      }

      function sendData(body) {
        fetch(API_URL, { method: "POST", body: JSON.stringify(body) })
        .then(r => r.json())
        .then(res => {
            hideLoading();
            if(res.success) { 
              const pu = APP_CONFIG.programUrls || {};
              const successHTML = `
                <div class="success-box">
                  <span class="success-icon">üéâ</span>
                  <h3 class="success-title">Application Submitted!</h3>
                  <p class="success-desc">${res.message}</p>
                  <p style="font-weight:600; color:#2d3436; margin-top:20px;">Explore Opportunities:</p>
                  <div class="cards-grid">
                    <a href="${pu.gpi}" target="_blank" class="card-link"><span class="card-icon">üåç</span><span class="card-title">GPI Program</span><span class="card-sub">Global Project Initiative</span></a>
                    <a href="${pu.industryTraining}" target="_blank" class="card-link"><span class="card-icon">üõ†Ô∏è</span><span class="card-title">Industry Training</span><span class="card-sub">Hands-on Technical Skills</span></a>
                    <a href="${pu.sel}" target="_blank" class="card-link"><span class="card-icon">üöÄ</span><span class="card-title">SEL Program</span><span class="card-sub">Student Engagement Learning</span></a>
                    <a href="${pu.jobs}" target="_blank" class="card-link"><span class="card-icon">üíº</span><span class="card-title">Jobs</span><span class="card-sub">Career Opportunities</span></a>
                  </div>
                </div>
              `;
              messageArea.innerHTML = successHTML;
              formContainer.classList.add('hidden'); 
              messageArea.scrollIntoView({ behavior: 'smooth' });
            } else { 
              showMessage('Error: ' + res.message, 'error'); 
            }
        })
        .catch(err => { hideLoading(); showMessage('Network Error', 'error'); });
      }

      // --- INITIALIZATION ---
      showLoading('Loading configuration...');
      fetch(API_URL + "?action=getInitialData").then(r=>r.json()).then(data => {
         PERSONA_FIELDS = data.fields;
         APP_CONFIG = data.config;
         
         if(APP_CONFIG.logoUrl) { companyLogoImg.src = APP_CONFIG.logoUrl; companyLogoImg.style.display=''; }
         if(APP_CONFIG.selectOptions) {
            createDatalist('universities_list', APP_CONFIG.selectOptions.universities);
            createDatalist('cities_list', APP_CONFIG.selectOptions.cities);
            createDatalist('countries_list', APP_CONFIG.selectOptions.countries);
            createDatalist('skills_list', APP_CONFIG.selectOptions.skills);
            createDatalist('companies_list', APP_CONFIG.selectOptions.companies);
            createDatalist('sources_list', APP_CONFIG.selectOptions.sources);
            createDatalist('industries_list', APP_CONFIG.selectOptions.industries);
         }
         Object.keys(PERSONA_FIELDS).forEach(p => { const opt = document.createElement('option'); opt.value = p; opt.textContent = p; personaSelect.appendChild(opt); });
         hideLoading();
      }).catch(e => {
         hideLoading();
         showMessage("Failed to load form. Please refresh.", "error");
      });

      // ‚úÖ LOGIC UPDATED: Faculty Selection
      personaSelect.addEventListener('change', () => { 
          currentPersona = personaSelect.value;
          
          if (!currentPersona) {
              actionButtons.classList.add('hidden');
              facultyImmediateArea.classList.add('hidden');
              formContainer.classList.add('hidden');
              editEmailArea.classList.add('hidden');
              return;
          }

          // ‚úÖ CHECK FOR FACULTY FIRST
          if (currentPersona === "College Faculty") {
              actionButtons.classList.add('hidden');
              editEmailArea.classList.add('hidden');
              formContainer.classList.add('hidden');
              
              // Render Message Immediately
              const url = APP_CONFIG.collegeFacultyFormUrl || "#";
              facultyImmediateArea.innerHTML = `
                <div class="faculty-box">
                    <div style="font-size:40px; margin-bottom:10px;">üë®‚Äçüè´</div>
                    <h3>Welcome, College Faculty!</h3>
                    <p>We have a dedicated application portal for college faculties.</p>
                    <a href="${url}" target="_blank" class="btn primary" style="display:inline-block; text-decoration:none; margin-top:15px;">Faculty Form</a>
                </div>`;
              facultyImmediateArea.classList.remove('hidden');
              return; 
          }

          // Normal Flow for other Personas
          facultyImmediateArea.classList.add('hidden');
          actionButtons.classList.remove('hidden');
          
          if (currentMode === 'new') { buildFormForPersona(currentPersona, {}); } 
          else if (currentMode === 'edit') { 
              formContainer.classList.add('hidden'); 
              editEmailArea.classList.remove('hidden');
              showMessage("Persona changed. Please load your record again.", "checking");
          }
      });

      btnNew.addEventListener('click', () => { currentMode = 'new'; editEmailArea.classList.add('hidden'); buildFormForPersona(currentPersona, {}); });
      btnEdit.addEventListener('click', () => { currentMode = 'edit'; editEmailArea.classList.remove('hidden'); formContainer.classList.add('hidden'); messageArea.innerHTML=''; });
      
      loadButton.addEventListener('click', () => {
         const email = editEmailInput.value;
         if(!email) return;
         showLoading('Fetching your record...');
         fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "fetchRecordForEdit", payload: { persona: currentPersona, email } }) })
         .then(r => r.json()).then(res => { 
             hideLoading();
             if(res.found) { buildFormForPersona(currentPersona, res.values); }
             else { showMessage('Record not found. Please check email or persona.', 'error'); }
         });
      });
    </script>
  </body>
</html>
